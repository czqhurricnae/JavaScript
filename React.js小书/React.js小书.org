# -*- eval: (setq org-download-image-dir (concat default-directory "/screenshotImg")); -*-
#+LATEX_CLASS: ctexbook
* React.js ç®€ä»‹
React.js æ˜¯ä¸€ä¸ªå¸®åŠ©ä½ æ„å»ºé¡µé¢ UI çš„åº“. å¦‚æœä½ ç†Ÿæ‚‰ MVC æ¦‚å¿µçš„è¯, é‚£ä¹ˆ React çš„ç»„ä»¶å°±
ç›¸å½“äº MVC é‡Œé¢çš„ View. å¦‚æœä½ ä¸ç†Ÿæ‚‰ä¹Ÿæ²¡å…³ç³», ä½ å¯ä»¥ç®€å•åœ°ç†è§£ä¸º,React.js å°†å¸®åŠ©
æˆ‘ä»¬å°†ç•Œé¢åˆ†æˆäº†å„ä¸ªç‹¬ç«‹çš„å°å—, æ¯ä¸€ä¸ªå—å°±æ˜¯ç»„ä»¶, è¿™äº›ç»„ä»¶ä¹‹é—´å¯ä»¥ç»„åˆ, åµŒå¥—, å°±æˆ
äº†æˆ‘ä»¬çš„é¡µé¢.

ä¸€ä¸ªç»„ä»¶çš„æ˜¾ç¤ºå½¢æ€å’Œè¡Œä¸ºæœ‰å¯èƒ½æ˜¯ç”±æŸäº›æ•°æ®å†³å®šçš„. è€Œæ•°æ®æ˜¯å¯èƒ½å‘ç”Ÿæ”¹å˜çš„, è¿™æ—¶å€™ç»„
ä»¶çš„æ˜¾ç¤ºå½¢æ€å°±ä¼šå‘ç”Ÿç›¸åº”çš„æ”¹å˜. è€Œ React.js ä¹Ÿæä¾›äº†ä¸€ç§éå¸¸é«˜æ•ˆçš„æ–¹å¼å¸®åŠ©æˆ‘ä»¬åšåˆ°
äº†æ•°æ®å’Œç»„ä»¶æ˜¾ç¤ºå½¢æ€ä¹‹é—´çš„åŒæ­¥.

React.js ä¸æ˜¯ä¸€ä¸ªæ¡†æ¶, å®ƒåªæ˜¯ä¸€ä¸ªåº“. å®ƒåªæä¾› UI(view) å±‚é¢çš„è§£å†³æ–¹æ¡ˆ. åœ¨å®é™…çš„é¡¹
ç›®å½“ä¸­, å®ƒå¹¶ä¸èƒ½è§£å†³æˆ‘ä»¬æ‰€æœ‰çš„é—®é¢˜, éœ€è¦ç»“åˆå…¶å®ƒçš„åº“, ä¾‹å¦‚ Redux,React-router ç­‰æ¥
ååŠ©æä¾›å®Œæ•´çš„è§£å†³æ–¹æ³•.

* å‰ç«¯ç»„ä»¶åŒ–(ä¸€): ä»ä¸€ä¸ªç®€å•çš„ä¾‹å­è®²èµ·
å¾ˆå¤šè¯¾ç¨‹ä¸€ä¸Šæ¥å°±ç»™å¤§å®¶å¦‚ä½•é…ç½®ç¯å¢ƒ, æ€ä¹ˆå†™ React.js ç»„ä»¶. ä½†æ˜¯æœ¬è¯¾ç¨‹è¿˜æ˜¯å¸Œæœ›å¤§å®¶å¯¹é—®é¢˜çš„æ ¹æºæœ‰ä¸€ä¸ªæ›´åŠ æ·±å…¥çš„äº†è§£, å…¶å®å¾ˆå¤šçš„åº“, æ¡†æ¶éƒ½æ˜¯è§£å†³ç±»ä¼¼çš„é—®é¢˜. åªæœ‰æˆ‘ä»¬å¯¹è¿™äº›åº“, æ¡†æ¶è§£å†³çš„é—®é¢˜æœ‰æ·±å…¥çš„äº†è§£å’Œæ€è€ƒä»¥å, æˆ‘ä»¬æ‰èƒ½å¾—å¿ƒåº”æ‰‹åœ°ä½¿ç”¨å®ƒä»¬, å¹¶ä¸”æœ‰æ–°çš„æ¡†æ¶å‡ºæ¥ä¹Ÿä¸ä¼šå¤ªè¿‡è¿·èŒ«â€”â€”â€”â€”å› ä¸ºå…¶å®å®ƒä»¬è§£å†³éƒ½æ˜¯åŒä¸€ä¸ªé—®é¢˜.

è¿™ä¸¤èŠ‚è¯¾æˆ‘ä»¬æ¥æ¢è®¨ä¸€ä¸‹æ˜¯ä»€ä¹ˆæ ·çš„é—®é¢˜å¯¼è‡´äº†æˆ‘ä»¬éœ€è¦å‰ç«¯é¡µé¢è¿›è¡Œç»„ä»¶åŒ–, å‰ç«¯é¡µé¢çš„ç»„ä»¶åŒ–éœ€è¦è§£å†³ä»€ä¹ˆæ ·çš„é—®é¢˜. åç»­è¯¾ç¨‹æˆ‘ä»¬å†æ¥çœ‹çœ‹ React.js æ˜¯æ€ä¹ˆè§£å†³è¿™äº›é—®é¢˜çš„.

æ‰€ä»¥è¿™å‡ èŠ‚æ‰€è®²çš„å†…å®¹å°†å’Œ React.js çš„å†…å®¹æ²¡æœ‰å¤ªå¤§çš„å…³ç³», ä½†æ˜¯å¦‚æœä½ èƒ½é¡ºåˆ©äº†è§£è¿™å‡ èŠ‚çš„å†…å®¹, é‚£ä¹ˆåé¢é‚£äº›å¯¹æ–°æ‰‹æ¥è¯´å¾ˆå¤æ‚çš„æ¦‚å¿µå¯¹ä½ æ¥è¯´å°±æ˜¯éå¸¸è‡ªç„¶çš„äº‹.

** ä¸€ä¸ªç®€å•çš„ç‚¹èµåŠŸèƒ½
 æˆ‘ä»¬ä¼šä»ä¸€ä¸ªç®€å•çš„ç‚¹èµåŠŸèƒ½è®²èµ·. å‡è®¾ç°åœ¨æˆ‘ä»¬éœ€è¦å®ç°ä¸€ä¸ªç‚¹èµ, å–æ¶ˆç‚¹èµçš„åŠŸèƒ½.

 [[file:screenshotImg/B7575C67-64F8-4A13-9C63-4D6805FA360D.png][file:screenshotImg/B7575C67-64F8-4A13-9C63-4D6805FA360D.png]]

 å¦‚æœä½ å¯¹å‰ç«¯ç¨å¾®æœ‰ä¸€ç‚¹äº†è§£, ä½ å°±é¡ºæ‰‹æ‹ˆæ¥:

 #+BEGIN_SRC html
 <body>
   <div class='wrapper'>
     <button class='like-btn'>
       <span class='like-text'>ç‚¹èµ</span>
       <span>ğŸ‘</span>
     </button>
   </div>
 </body>
 #+END_SRC

 ä¸ºäº†æ¨¡æ‹Ÿç°å®å½“ä¸­çš„å®é™…æƒ…å†µ, æ‰€ä»¥è¿™é‡Œç‰¹æ„æŠŠè¿™ä¸ª button é‡Œé¢çš„ HTML ç»“æ„æå¾—ç¨å¾®å¤æ‚ä¸€äº›. æœ‰äº†è¿™ä¸ª HTML ç»“æ„, ç°åœ¨å°±ç»™å®ƒåŠ å…¥ä¸€äº› JavaScript çš„è¡Œä¸º:

 #+BEGIN_SRC javascript
 const button = document.querySelector('.like-btn')
     const buttonText = button.querySelector('.like-text')
     let isLiked = false
     button.addEventListener('click', () => {
             isLiked = !isLiked
             if (isLiked) {
                 buttonText.innerHTML = 'å–æ¶ˆ'
             } else {
                 buttonText.innerHTML = 'ç‚¹èµ'
             }
         }, false)
 #+END_SRC

 åŠŸèƒ½å’Œå®ç°éƒ½å¾ˆç®€å•, æŒ‰é’®å·²ç»å¯ä»¥æä¾›ç‚¹èµå’Œå–æ¶ˆç‚¹èµçš„åŠŸèƒ½. è¿™æ—¶å€™ä½ çš„åŒäº‹è·‘è¿‡æ¥äº†, è¯´ä»–å¾ˆå–œæ¬¢ä½ çš„æŒ‰é’®, ä»–ä¹Ÿæƒ³ç”¨ä½ å†™çš„è¿™ä¸ªç‚¹èµåŠŸèƒ½. è¿™æ—¶å€™é—®é¢˜å°±æ¥äº†, ä½ å°±ä¼šå‘ç°è¿™ç§å®ç°æ–¹å¼å¾ˆè‡´å‘½: ä½ çš„åŒäº‹è¦æŠŠæ•´ä¸ª button å’Œé‡Œé¢çš„ç»“æ„å¤åˆ¶è¿‡å», è¿˜æœ‰æ•´æ®µ JavaScript ä»£ç ä¹Ÿè¦å¤åˆ¶è¿‡å». è¿™æ ·çš„å®ç°æ–¹å¼æ²¡æœ‰ä»»ä½•å¯å¤ç”¨æ€§.

** ç»“æ„å¤ç”¨
 ç°åœ¨æˆ‘ä»¬æ¥é‡æ–°ç¼–å†™è¿™ä¸ªç‚¹èµåŠŸèƒ½, è®©å®ƒå…·å¤‡ä¸€å®šçš„å¯å¤ç”¨. è¿™æ¬¡æˆ‘ä»¬å…ˆå†™ä¸€ä¸ªç±», è¿™ä¸ªç±»æœ‰ render æ–¹æ³•, è¿™ä¸ªæ–¹æ³•é‡Œé¢ç›´æ¥è¿”å›ä¸€ä¸ªè¡¨ç¤º HTML ç»“æ„çš„å­—ç¬¦ä¸²:

 #+BEGIN_SRC javascript
 class LikeButton {
    render () {
        return `
         <button id='like-btn'>
           <span class='like-text'>èµ</span>
           <span>ğŸ‘</span>
         </button>
       `
    }
 }
 #+END_SRC

 ç„¶åå¯ä»¥ç”¨è¿™ä¸ªç±»æ¥æ„å»ºä¸åŒçš„ç‚¹èµåŠŸèƒ½çš„å®ä¾‹, ç„¶åæŠŠå®ƒä»¬æ’åˆ°é¡µé¢ä¸­.

 #+BEGIN_SRC javascript
 const wrapper = document.querySelector('.wrapper')
 const likeButton1 = new LikeButton()
 wrapper.innerHTML = likeButton1.render()

 const likeButton2 = new LikeButton()
 wrapper.innerHTML += likeButton2.render()
 #+END_SRC

 è¿™é‡Œéå¸¸æš´åŠ›åœ°ä½¿ç”¨äº† innerHTML , æŠŠä¸¤ä¸ªæŒ‰é’®ç²—é²åœ°æ’å…¥äº† wrapper å½“ä¸­. è™½ç„¶ä½ å¯èƒ½ä¼šå¯¹è¿™ç§å®ç°æ–¹å¼éå¸¸ä¸æ»¡æ„, ä½†æˆ‘ä»¬è¿˜æ˜¯å‹‰å¼ºäº†å®ç°äº†ç»“æ„çš„å¤ç”¨. æˆ‘ä»¬åé¢å†æ¥ä¼˜åŒ–å®ƒ.

** å®ç°ç®€å•çš„ç»„ä»¶åŒ–
 ä½ ä¸€å®šä¼šå‘ç°, ç°åœ¨çš„æŒ‰é’®æ˜¯æ­»çš„, ä½ ç‚¹å‡»å®ƒå®ƒæ ¹æœ¬ä¸ä¼šæœ‰ä»€ä¹ˆååº”. å› ä¸ºæ ¹æœ¬æ²¡æœ‰å¾€ä¸Šé¢æ·»åŠ äº‹ä»¶. ä½†æ˜¯é—®é¢˜æ¥äº†, LikeButton ç±»é‡Œé¢æ˜¯è™½ç„¶è¯´æœ‰ä¸€ä¸ª button, ä½†æ˜¯è¿™ç©æ„æ ¹æœ¬å°±æ˜¯åœ¨å­—ç¬¦ä¸²é‡Œé¢çš„. ä½ æ€ä¹ˆèƒ½å¾€ä¸€ä¸ªå­—ç¬¦ä¸²é‡Œé¢æ·»åŠ äº‹ä»¶å‘¢?DOM äº‹ä»¶çš„ API åªæœ‰ DOM ç»“æ„æ‰èƒ½ç”¨.

 æˆ‘ä»¬éœ€è¦ DOM ç»“æ„, å‡†ç¡®åœ°æ¥è¯´: æˆ‘ä»¬éœ€è¦è¿™ä¸ªç‚¹èµåŠŸèƒ½çš„ HTML å­—ç¬¦ä¸²è¡¨ç¤ºçš„ DOM ç»“æ„. å‡è®¾æˆ‘ä»¬ç°åœ¨æœ‰ä¸€ä¸ªå‡½æ•° =createDOMFromString=, ä½ å¾€è¿™ä¸ªå‡½æ•°ä¼ å…¥ HTML å­—ç¬¦ä¸², ä½†æ˜¯å®ƒä¼šæŠŠç›¸åº”çš„ DOM å…ƒç´ è¿”å›ç»™ä½ . è¿™ä¸ªé—®é¢˜å°±å¯ä»¥è§£å†³äº†.

 #+CAPTION: createDOMFromString
 #+BEGIN_SRC javascript
 // ::String => ::Document
 const createDOMFromString = (domString) => {
     const div = document.createElement('div')
     div.innerHTML = domString
     return div
 }
 #+END_SRC
 <<createDOMFromString>>

 å…ˆä¸ç”¨ç®¡è¿™ä¸ªå‡½æ•°åº”è¯¥æ€ä¹ˆå®ç°, å…ˆçŸ¥é“å®ƒæ˜¯å¹²å˜›çš„. æ‹¿æ¥ç”¨å°±å¥½, è¿™æ—¶å€™ç”¨å®ƒæ¥æ”¹å†™ä¸€ä¸‹ LikeButton ç±»:

 #+CAPTION: render
 #+BEGIN_SRC javascript
 class LikeButton {
     render () {
         this.el = createDOMFromString(`
         <button class='like-button'>
           <span class='like-text'>ç‚¹èµ</span>
           <span>ğŸ‘</span>
         </button>
       `)
         this.el.addEventListener('click', () => console.log('click'), false)
         return this.el
     }
 }
 #+END_SRC
 <<render>>

 ç°åœ¨ render() è¿”å›çš„ä¸æ˜¯ä¸€ä¸ª html å­—ç¬¦ä¸²äº†, è€Œæ˜¯ä¸€ä¸ªç”±è¿™ä¸ª html å­—ç¬¦ä¸²æ‰€ç”Ÿæˆçš„ DOM. åœ¨è¿”å› DOM å…ƒç´ ä¹‹å‰ä¼šå…ˆç»™è¿™ä¸ª DOM å…ƒç´ ä¸Šæ·»åŠ äº‹ä»¶å†è¿”å›.

 å› ä¸ºç°åœ¨ render è¿”å›çš„æ˜¯ DOM å…ƒç´ , æ‰€ä»¥ä¸èƒ½ç”¨ innerHTML æš´åŠ›åœ°æ’å…¥ wrapper. è€Œæ˜¯è¦ç”¨ =DOM API= æ’è¿›å».

 #+BEGIN_SRC javascript :results valuse list
 const wrapper = document.querySelector('.wrapper')

 const likeButton1 = new LikeButton()
 wrapper.appendChild(likeButton1.render())

 const likeButton2 = new LikeButton()
 wrapper.appendChild(likeButton2.render())
 #+END_SRC

 ç°åœ¨ä½ ç‚¹å‡»è¿™ä¸¤ä¸ªæŒ‰é’®, æ¯ä¸ªæŒ‰é’®éƒ½ä¼šåœ¨æ§åˆ¶å°æ‰“å° click, è¯´æ˜äº‹ä»¶ç»‘å®šæˆåŠŸäº†. ä½†æ˜¯æŒ‰é’®ä¸Šçš„æ–‡æœ¬è¿˜æ˜¯æ²¡æœ‰å‘ç”Ÿæ”¹å˜, åªè¦ç¨å¾®æ”¹åŠ¨ä¸€ä¸‹ LikeButton çš„ä»£ç å°±å¯ä»¥å®Œæˆå®Œæ•´çš„åŠŸèƒ½:

 #+BEGIN_SRC javascript
 class LikeButton {
     constructor () {
         this.state = { isLiked: false }
     }

     changeLikeText () {
         const likeText = this.el.querySelector('.like-text')
         this.state.isLiked = !this.state.isLiked
         likeText.innerHTML = this.state.isLiked ? 'å–æ¶ˆ' : 'ç‚¹èµ'
     }

     render () {
         this.el = createDOMFromString(`
         <button class='like-button'>
           <span class='like-text'>ç‚¹èµ</span>
           <span>ğŸ‘</span>
         </button>
       `)
         this.el.addEventListener('click', this.changeLikeText.bind(this), false)
         return this.el
     }
 }
 #+END_SRC

 è¿™é‡Œçš„ä»£ç ç¨å¾®é•¿äº†ä¸€äº›, ä½†æ˜¯è¿˜æ˜¯å¾ˆå¥½ç†è§£. åªä¸è¿‡æ˜¯åœ¨ç»™ LikeButton ç±»æ·»åŠ äº†æ„é€ å‡½æ•°, è¿™ä¸ªæ„é€ å‡½æ•°ä¼šç»™æ¯ä¸€ä¸ª LikeButton çš„å®ä¾‹æ·»åŠ ä¸€ä¸ªå¯¹è±¡ state,state é‡Œé¢ä¿å­˜äº†æ¯ä¸ªæŒ‰é’®è‡ªå·±æ˜¯å¦ç‚¹èµçš„çŠ¶æ€. è¿˜æ”¹å†™äº†åŸæ¥çš„äº‹ä»¶ç»‘å®šå‡½æ•°: åŸæ¥åªæ‰“å° click, ç°åœ¨ç‚¹å‡»çš„æŒ‰é’®çš„æ—¶å€™ä¼šè°ƒç”¨ changeLikeText æ–¹æ³•, è¿™ä¸ªæ–¹æ³•ä¼šæ ¹æ® this.state çš„çŠ¶æ€æ”¹å˜ç‚¹èµæŒ‰é’®çš„æ–‡æœ¬.

 ç°åœ¨è¿™ä¸ªç»„ä»¶çš„å¯å¤ç”¨æ€§å·²ç»å¾ˆä¸é”™äº†, ä½ çš„åŒäº‹ä»¬åªè¦å®ä¾‹åŒ–ä¸€ä¸‹ç„¶åæ’å…¥åˆ° DOM é‡Œé¢å»å°±å¥½äº†.

 ä¸‹ä¸€èŠ‚æˆ‘ä»¬ç»§ç»­ä¼˜åŒ–è¿™ä¸ªä¾‹å­, è®©å®ƒæ›´åŠ é€šç”¨.

* å‰ç«¯ç»„ä»¶åŒ–(äºŒ): ä¼˜åŒ– DOM æ“ä½œ
çœ‹çœ‹ä¸Šä¸€èŠ‚æˆ‘ä»¬çš„ä»£ç , ä»”ç»†ç•™æ„ä¸€ä¸‹ changeLikeText å‡½æ•°, è¿™ä¸ªå‡½æ•°åŒ…å«äº† DOM æ“ä½œ, ç°åœ¨çœ‹èµ·æ¥æ¯”è¾ƒç®€å•, é‚£æ˜¯å› ä¸ºç°åœ¨åªæœ‰ isLiked ä¸€ä¸ªçŠ¶æ€. ç”±äºæ•°æ®çŠ¶æ€æ”¹å˜ä¼šå¯¼è‡´éœ€è¦æˆ‘ä»¬å»æ›´æ–°é¡µé¢çš„å†…å®¹, æ‰€ä»¥å‡æƒ³ä¸€ä¸‹, å¦‚æœä½ çš„ç»„ä»¶ä¾èµ–äº†å¾ˆå¤šçŠ¶æ€, é‚£ä¹ˆä½ çš„ç»„ä»¶åŸºæœ¬å…¨éƒ¨éƒ½æ˜¯ DOM æ“ä½œ.

ä¸€ä¸ªç»„ä»¶çš„æ˜¾ç¤ºå½¢æ€ç”±å¤šä¸ªçŠ¶æ€å†³å®šçš„æƒ…å†µéå¸¸å¸¸è§. ä»£ç ä¸­æ··æ‚ç€å¯¹ DOM çš„æ“ä½œå…¶å®æ˜¯ä¸€ç§ä¸å¥½çš„å®è·µ, æ‰‹åŠ¨ç®¡ç†æ•°æ®å’Œ DOM ä¹‹é—´çš„å…³ç³»ä¼šå¯¼è‡´ä»£ç å¯ç»´æŠ¤æ€§å˜å·®, å®¹æ˜“å‡ºé”™. æ‰€ä»¥æˆ‘ä»¬çš„ä¾‹å­è¿™é‡Œè¿˜æœ‰ä¼˜åŒ–çš„ç©ºé—´: å¦‚ä½•å°½é‡å‡å°‘è¿™ç§æ‰‹åŠ¨ DOM æ“ä½œ?

** çŠ¶æ€æ”¹å˜ -> æ„å»ºæ–°çš„ DOM å…ƒç´ æ›´æ–°é¡µé¢
 è¿™é‡Œè¦æå‡ºçš„ä¸€ç§è§£å†³æ–¹æ¡ˆ: ä¸€æ—¦çŠ¶æ€å‘ç”Ÿæ”¹å˜, å°±é‡æ–°è°ƒç”¨ render æ–¹æ³•, æ„å»ºä¸€ä¸ªæ–°çš„ DOM å…ƒç´ . è¿™æ ·åšçš„å¥½å¤„æ˜¯ä»€ä¹ˆå‘¢? å¥½å¤„å°±æ˜¯ä½ å¯ä»¥åœ¨ render æ–¹æ³•é‡Œé¢ä½¿ç”¨æœ€æ–°çš„ this.state æ¥æ„é€ ä¸åŒ HTML ç»“æ„çš„å­—ç¬¦ä¸², å¹¶ä¸”é€šè¿‡è¿™ä¸ªå­—ç¬¦ä¸²æ„é€ ä¸åŒçš„ DOM å…ƒç´ . é¡µé¢å°±æ›´æ–°äº†! å¬èµ·æ¥æœ‰ç‚¹ç»•, çœ‹çœ‹ä»£ç æ€ä¹ˆå†™, ä¿®æ”¹åŸæ¥çš„ä»£ç ä¸º:

 #+BEGIN_SRC javascript
 class LikeButton {
     constructor () {
         this.state = { isLiked: false }
     }

     setState (state) {
         this.state = state
         this.el = this.render()
     }

     changeLikeText () {
         this.setState({
             isLiked: !this.state.isLiked
         })
     }

     render () {
         this.el = createDOMFromString(`
         <button class='like-btn'>
           <span class='like-text'>${this.state.isLiked ? 'å–æ¶ˆ' : 'ç‚¹èµ'}</span>
           <span>ğŸ‘</span>
         </button>
       `)
         this.el.addEventListener('click', this.changeLikeText.bind(this), false)
         return this.el
     }
 }
 #+END_SRC
 [[createDOMFromString][See createDOMFromString]]

 å…¶å®åªæ˜¯æ”¹äº†å‡ ä¸ªå°åœ°æ–¹:
 render å‡½æ•°é‡Œé¢çš„ HTML å­—ç¬¦ä¸²ä¼šæ ¹æ® this.state ä¸åŒè€Œä¸åŒ(è¿™é‡Œæ˜¯ç”¨äº† ES6 çš„æ¨¡ç‰ˆå­—ç¬¦ä¸², åšè¿™ç§äº‹æƒ…å¾ˆæ–¹ä¾¿).
 æ–°å¢ä¸€ä¸ª =setState= å‡½æ•°, è¿™ä¸ªå‡½æ•°æ¥å—ä¸€ä¸ªå¯¹è±¡ä½œä¸ºå‚æ•°, å®ƒä¼šè®¾ç½®å®ä¾‹çš„ state, ç„¶åé‡æ–°è°ƒç”¨ä¸€ä¸‹ render æ–¹æ³•.
 å½“ç”¨æˆ·ç‚¹å‡»æŒ‰é’®çš„æ—¶å€™, =changeLikeText= ä¼šæ„å»ºæ–°çš„ state å¯¹è±¡, è¿™ä¸ªæ–°çš„ state, ä¼ å…¥ setState å‡½æ•°å½“ä¸­.
 è¿™æ ·çš„ç»“æœå°±æ˜¯, ç”¨æˆ·æ¯æ¬¡ç‚¹å‡», =changeLikeText= éƒ½ä¼šè°ƒç”¨æ”¹å˜ç»„ä»¶çŠ¶æ€ç„¶åè°ƒç”¨ setState,setState ä¼šè°ƒç”¨ render,render æ–¹æ³•ä¼šæ ¹æ® state çš„ä¸åŒé‡æ–°æ„å»ºä¸åŒçš„ DOM å…ƒç´ .

 ä¹Ÿå°±æ˜¯è¯´, ä½ åªè¦è°ƒç”¨ setState, ç»„ä»¶å°±ä¼šé‡æ–°æ¸²æŸ“. æˆ‘ä»¬é¡ºåˆ©åœ°æ¶ˆé™¤äº†æ‰‹åŠ¨çš„ DOM æ“ä½œ.

** é‡æ–°æ’å…¥æ–°çš„ DOM å…ƒç´ 
 ä¸Šé¢çš„æ”¹è¿›ä¸ä¼šæœ‰ä»€ä¹ˆæ•ˆæœ, å› ä¸ºä½ ä»”ç»†çœ‹ä¸€ä¸‹å°±ä¼šå‘ç°, å…¶å®é‡æ–°æ¸²æŸ“çš„ DOM å…ƒç´ å¹¶æ²¡æœ‰æ’å…¥åˆ°é¡µé¢å½“ä¸­. æ‰€ä»¥åœ¨è¿™ä¸ªç»„ä»¶å¤–é¢, ä½ éœ€è¦çŸ¥é“è¿™ä¸ªç»„ä»¶å‘ç”Ÿäº†æ”¹å˜, å¹¶ä¸”æŠŠæ–°çš„ DOM å…ƒç´ æ›´æ–°åˆ°é¡µé¢å½“ä¸­.

 é‡æ–°ä¿®æ”¹ä¸€ä¸‹ =setState= æ–¹æ³•:

 #+CAPTION: setState
 #+BEGIN_SRC javascript
 ...
     setState (state) {
         const oldEl = this.el
         this.state = state
         this.el = this.render()
         if (this.onStateChange) this.onStateChange(oldEl, this.el)
     }
 ...
 #+END_SRC
 <<setState>>

 ä½¿ç”¨è¿™ä¸ªç»„ä»¶çš„æ—¶å€™:

 #+BEGIN_SRC javascript
 const likeButton = new LikeButton()
 wrapper.appendChild(likeButton.render()) // ç¬¬ä¸€æ¬¡æ’å…¥ DOM å…ƒç´ 
 likeButton.onStateChange = (oldEl, newEl) => {
     wrapper.insertBefore(newEl, oldEl) // æ’å…¥æ–°çš„å…ƒç´ 
     wrapper.removeChild(oldEl) // åˆ é™¤æ—§çš„å…ƒç´ 
 }
 #+END_SRC
 <<onStateChange>>

 è¿™é‡Œæ¯æ¬¡ =setState= éƒ½ä¼šè°ƒç”¨ =onStateChange= æ–¹æ³•, è€Œè¿™ä¸ªæ–¹æ³•æ˜¯å®ä¾‹åŒ–ä»¥åæ—¶å€™è¢«è®¾ç½®çš„, æ‰€ä»¥ä½ å¯ä»¥è‡ªå®šä¹‰ =onStateChange= çš„è¡Œä¸º. è¿™é‡Œåšçš„äº‹æ˜¯, æ¯å½“ =setState= ä¸­æ„é€ å®Œæ–°çš„ DOM å…ƒç´ ä»¥å, å°±ä¼šé€šè¿‡ =onStateChange= å‘ŠçŸ¥å¤–éƒ¨æ’å…¥æ–°çš„ DOM å…ƒç´ , ç„¶ååˆ é™¤æ—§çš„å…ƒç´ , é¡µé¢å°±æ›´æ–°äº†.
 è¿™é‡Œå·²ç»åšåˆ°äº†è¿›ä¸€æ­¥çš„ä¼˜åŒ–äº†: ç°åœ¨ä¸éœ€è¦å†æ‰‹åŠ¨æ›´æ–°é¡µé¢äº†.

 éä¸€èˆ¬çš„æš´åŠ›, å› ä¸ºæ¯æ¬¡ =setState= éƒ½é‡æ–°æ„é€ , æ–°å¢, åˆ é™¤ DOM å…ƒç´ , ä¼šå¯¼è‡´æµè§ˆå™¨è¿›è¡Œå¤§é‡çš„é‡æ’, ä¸¥é‡å½±å“æ€§èƒ½. ä¸è¿‡æ²¡æœ‰å…³ç³», è¿™ç§æš´åŠ›è¡Œä¸ºå¯ä»¥è¢«ä¸€ç§å« =Virtual-DOM= çš„ç­–ç•¥è§„é¿æ‰, ä½†è¿™ä¸æ˜¯æœ¬æ–‡æ‰€è®¨è®ºçš„èŒƒå›´.

 è¿™ä¸ªç‰ˆæœ¬çš„ç‚¹èµåŠŸèƒ½å¾ˆä¸é”™, æˆ‘å¯ä»¥ç»§ç»­å¾€ä¸Šé¢åŠ åŠŸèƒ½, è€Œä¸”è¿˜ä¸éœ€è¦æ‰‹åŠ¨æ“ä½œ DOM. ä½†æ˜¯æœ‰ä¸€ä¸ªä¸å¥½çš„åœ°æ–¹, å¦‚æœæˆ‘è¦é‡æ–°å¦å¤–åšä¸€ä¸ªæ–°ç»„ä»¶, è­¬å¦‚è¯´è¯„è®ºç»„ä»¶, é‚£ä¹ˆé‡Œé¢çš„è¿™äº› =setState= æ–¹æ³•è¦é‡æ–°å†™ä¸€é, å…¶å®è¿™äº›ä¸œè¥¿éƒ½å¯ä»¥æŠ½å‡ºæ¥, å˜æˆä¸€ä¸ªé€šç”¨çš„æ¨¡å¼. ä¸‹ä¸€èŠ‚æˆ‘ä»¬æŠŠè¿™ä¸ªé€šç”¨æ¨¡å¼æŠ½ç¦»åˆ°ä¸€ä¸ªç±»å½“ä¸­.

* å‰ç«¯ç»„ä»¶åŒ–(ä¸‰): æŠ½è±¡å‡ºå…¬å…±ç»„ä»¶ç±»
ä¸ºäº†è®©ä»£ç æ›´çµæ´», å¯ä»¥å†™æ›´å¤šçš„ç»„ä»¶, æˆ‘ä»¬æŠŠè¿™ç§æ¨¡å¼æŠ½è±¡å‡ºæ¥, æ”¾åˆ°ä¸€ä¸ª Component ç±»å½“ä¸­:

#+CAPTION: _renderDOM
#+BEGIN_SRC javascript
class Component {
    setState (state) {
        const oldEl = this.el
        this.state = state
        this._renderDOM()
        if (this.onStateChange) this.onStateChange(oldEl, this.el)
    }

    _renderDOM () {
        this.el = createDOMFromString(this.render())
        if (this.onClick) {
            this.el.addEventListener('click', this.onClick.bind(this), false)
        }
        return this.el
    }
}
#+END_SRC
<<_renderDOM>>
[[createDOMFromString][
See createDOMFromString]]

[[%E8%BF%94%E5%9B%9E%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9A%84 render %E6%96%B9%E6%B3%95][See è¿”å›å­—ç¬¦ä¸²çš„ render æ–¹æ³•]]

[[setState][See setState]]

è¿™ä¸ªæ˜¯ä¸€ä¸ªç»„ä»¶çˆ¶ç±» Component, æ‰€æœ‰çš„ç»„ä»¶éƒ½å¯ä»¥ç»§æ‰¿è¿™ä¸ªçˆ¶ç±»æ¥æ„å»º. å®ƒå®šä¹‰çš„ä¸¤ä¸ªæ–¹æ³•, ä¸€ä¸ªæ˜¯æˆ‘ä»¬å·²ç»å¾ˆç†Ÿæ‚‰çš„ setState, ä¸€ä¸ªæ˜¯ç§æœ‰æ–¹æ³• =_renderDOM=.
=_renderDOM= æ–¹æ³•ä¼šè°ƒç”¨ this.render æ¥æ„å»º DOM å…ƒç´ å¹¶ä¸”ç›‘å¬ onClick äº‹ä»¶.
=æ‰€ä»¥, ç»„ä»¶å­ç±»ç»§æ‰¿çš„æ—¶å€™åªéœ€è¦å®ç°ä¸€ä¸ªè¿”å› HTML å­—ç¬¦ä¸²çš„ render æ–¹æ³•å°±å¯ä»¥äº†.=

è¿˜æœ‰ä¸€ä¸ªé¢å¤–çš„ =mount= çš„æ–¹æ³•, å…¶å®å°±æ˜¯æŠŠç»„ä»¶çš„ DOM å…ƒç´ æ’å…¥é¡µé¢, å¹¶ä¸”åœ¨ setState çš„æ—¶å€™æ›´æ–°é¡µé¢:

#+CAPTION: mount
#+BEGIN_SRC javascript
const mount = (component, wrapper) => {
    wrapper.appendChild(component._renderDOM())
    component.onStateChange = (oldEl, newEl) => {
        wrapper.insertBefore(newEl, oldEl)
        wrapper.removeChild(oldEl)
    }
}
#+END_SRC
<<mount>>

[[onStateChange][See onStateChange]]

è¿™æ ·çš„è¯æˆ‘ä»¬é‡æ–°å†™ç‚¹èµç»„ä»¶å°±ä¼šå˜æˆ:

#+CAPTION: è¿”å›å­—ç¬¦ä¸²çš„ render æ–¹æ³•
#+BEGIN_SRC javascript
class LikeButton extends Component {
    constructor () {
        super()
        this.state = { isLiked: false }
    }

    onClick () {
        this.setState({
            isLiked: !this.state.isLiked
        })
    }

    render () {
        return `
        <button class='like-btn'>
          <span class='like-text'>${this.state.isLiked ? 'å–æ¶ˆ' : 'ç‚¹èµ'}</span>
          <span>ğŸ‘</span>
        </button>
      `
    }
}

mount(new LikeButton(), wrapper)
#+END_SRC
<<è¿”å›å­—ç¬¦ä¸²çš„ render æ–¹æ³•>>

[[_renderDOM][See _renderDOM]]

è¿™æ ·è¿˜ä¸å¤Ÿå¥½. åœ¨å®é™…å¼€å‘å½“ä¸­, ä½ å¯èƒ½éœ€è¦ç»™ç»„ä»¶ä¼ å…¥ä¸€äº›è‡ªå®šä¹‰çš„é…ç½®æ•°æ®. ä¾‹å¦‚è¯´æƒ³é…ç½®ä¸€ä¸‹ç‚¹èµæŒ‰é’®çš„èƒŒæ™¯é¢œè‰², å¦‚æœæˆ‘ç»™å®ƒä¼ å…¥ä¸€ä¸ªå‚æ•°, å‘Šè¯‰å®ƒæ€ä¹ˆè®¾ç½®è‡ªå·±çš„é¢œè‰². é‚£ä¹ˆè¿™ä¸ªæŒ‰é’®çš„å®šåˆ¶æ€§å°±æ›´å¼ºäº†. æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç»™ç»„ä»¶ç±»å’Œå®ƒçš„å­ç±»éƒ½ä¼ å…¥ä¸€ä¸ªå‚æ•° props, ä½œä¸ºç»„ä»¶çš„é…ç½®å‚æ•°. ä¿®æ”¹ Component çš„æ„é€ å‡½æ•°ä¸º:

#+BEGIN_SRC javascript
...
    constructor (props = {}) {
        this.props = props
    }
...
#+END_SRC

ç»§æ‰¿çš„æ—¶å€™é€šè¿‡ super(props) æŠŠ props ä¼ ç»™çˆ¶ç±», è¿™æ ·å°±å¯ä»¥é€šè¿‡ this.props è·å–åˆ°é…ç½®å‚æ•°:

#+CAPTION: æ”¯æŒè¯»å– props å‚æ•°çš„ render æ–¹æ³•
#+BEGIN_SRC javascript
class LikeButton extends Component {
    constructor (props) {
        super(props)
        this.state = { isLiked: false }
    }

    onClick () {
        this.setState({
            isLiked: !this.state.isLiked
        })
    }

    render () {
        return `
        <button class='like-btn' style="background-color: ${this.props.bgColor}">
          <span class='like-text'>
            ${this.state.isLiked ? 'å–æ¶ˆ' : 'ç‚¹èµ'}
          </span>
          <span>ğŸ‘</span>
        </button>
      `
    }
}

mount(new LikeButton({ bgColor: 'red' }), wrapper)
#+END_SRC
<<æ”¯æŒè¯»å– props å‚æ•°çš„ render æ–¹æ³•>>

è¿™é‡Œæˆ‘ä»¬ç¨å¾®ä¿®æ”¹äº†ä¸€ä¸‹åŸæœ‰çš„ LikeButton çš„ =render= æ–¹æ³•, è®©å®ƒå¯ä»¥æ ¹æ®ä¼ å…¥çš„å‚æ•° =this.props.bgColor= æ¥ç”Ÿæˆä¸åŒçš„ style å±æ€§. è¿™æ ·å°±å¯ä»¥è‡ªç”±é…ç½®ç»„ä»¶çš„é¢œè‰²äº†.

åªè¦æœ‰äº†ä¸Šé¢é‚£ä¸ª =Component= ç±»å’Œ =mount= [[mount][See mount ]]æ–¹æ³•åŠ èµ·æ¥ä¸è¶³ 40 è¡Œä»£ç å°±å¯ä»¥åšåˆ°ç»„ä»¶åŒ–. å¦‚æœæˆ‘ä»¬éœ€è¦å†™å¦å¤–ä¸€ä¸ªç»„ä»¶, åªéœ€è¦åƒä¸Šé¢é‚£æ ·, ç®€å•åœ°ç»§æ‰¿ä¸€ä¸‹ Component ç±»å°±å¥½äº†:

#+BEGIN_SRC javascript
class RedBlueButton extends Component {
    constructor (props) {
        super(props)
        this.state = {
            color: 'red'
        }
    }

    onClick () {
        this.setState({
            color: 'blue'
        })
    }

    render () {
        return `
        <div style='color: ${this.state.color};'>${this.state.color}</div>
      `
    }
}
#+END_SRC

ç®€å•å¥½ç”¨, ç°åœ¨å¯ä»¥çµæ´»åœ°ç»„ä»¶åŒ–é¡µé¢äº†.Component å®Œæ•´çš„ä»£ç å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°.

#+CAPTION: reactjs-in-40
#+BEGIN_SRC javascript
<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <title>Reactjs in 40 </title>
    <style media="screen">
      .like-btn { font-size: 50px; }
    </style>
  </head>

  <body>
    <div class='wrapper'></div>
  </body>

  <script type="text/javascript">
    /* Component */
    class Component {
      constructor (props = {}) {
        this.props = props
      }
      setState (state) {
        const oldEl = this.el
        this.state = state
        this.el = this.renderDOM()
        if (this.onStateChange) this.onStateChange(oldEl, this.el)
      }
      renderDOM () {
        this.el = createDOMFromString(this.render())
        if (this.onClick) {
          this.el.addEventListener('click', this.onClick.bind(this), false)
        }
        return this.el
      }
    }
    const createDOMFromString = (domString) => {
      const div = document.createElement('div')
      div.innerHTML = domString
      return div
    }
    const mount = (component, wrapper) => {
      wrapper.appendChild(component.renderDOM())
      component.onStateChange = (oldEl, newEl) => {
        wrapper.insertBefore(newEl, oldEl)
        wrapper.removeChild(oldEl)
      }
    }
    /* ========================================= */
    class LikeButton extends Component {
      constructor (props) {
        super(props)
        this.state = { isLiked: false }
      }
      onClick () {
        this.setState({
          isLiked: !this.state.isLiked
        })
      }
      render () {
        return `
          <button class='like-btn' style="background-color: ${this.props.bgColor}">
            <span class='like-text'>
              ${this.state.isLiked ? 'å–æ¶ˆ' : 'ç‚¹èµ'}
            </span>
            <span>ğŸ‘</span>
          </button>
        `
      }
    }
    class RedBlueButton extends Component {
      constructor (props) {
        super(props)
        this.state = {
          color: 'red'
        }
      }
      onClick () {
        this.setState({
          color: 'blue'
        })
      }
      render () {
        return `
          <div style='color: ${this.state.color};'>${this.state.color}</div>
        `
      }
    }
    const wrapper = document.querySelector('.wrapper')
    mount(new LikeButton({ bgColor: 'red' }), wrapper)
    mount(new LikeButton(), wrapper)
    mount(new RedBlueButton(), wrapper)
  </script>
</html>
#+END_SRC
<<reactjs-in-40>>

** æ€»ç»“
 æˆ‘ä»¬ç”¨äº†å¾ˆé•¿çš„ç¯‡å¹…æ¥è®²ä¸€ä¸ªç®€å•çš„ç‚¹èµçš„ä¾‹å­, å¹¶ä¸”åœ¨è¿™ä¸ªè¿‡ç¨‹é‡Œé¢ä¸€ç›´åœ¨ä¼˜åŒ–ç¼–å†™çš„æ–¹å¼. æœ€åæŠ½ç¦»å‡ºæ¥äº†ä¸€ä¸ªç±», å¯ä»¥å¸®åŠ©æˆ‘ä»¬æ›´å¥½çš„åšç»„ä»¶åŒ–. åœ¨è¿™ä¸ªè¿‡ç¨‹é‡Œé¢æˆ‘ä»¬å­¦åˆ°äº†ä»€ä¹ˆ?

 ç»„ä»¶åŒ–å¯ä»¥å¸®åŠ©æˆ‘ä»¬è§£å†³å‰ç«¯ç»“æ„çš„å¤ç”¨æ€§é—®é¢˜, æ•´ä¸ªé¡µé¢å¯ä»¥ç”±è¿™æ ·çš„ä¸åŒçš„ç»„ä»¶ç»„åˆ, åµŒå¥—æ„æˆ.

 ä¸€ä¸ªç»„ä»¶æœ‰è‡ªå·±çš„æ˜¾ç¤ºå½¢æ€(ä¸Šé¢çš„ HTML ç»“æ„å’Œå†…å®¹) è¡Œä¸º, ç»„ä»¶çš„æ˜¾ç¤ºå½¢æ€å’Œè¡Œä¸ºå¯ä»¥ç”±æ•°æ®çŠ¶æ€(state) å’Œé…ç½®å‚æ•°(props) å…±åŒå†³å®š. æ•°æ®çŠ¶æ€å’Œé…ç½®å‚æ•°çš„æ”¹å˜éƒ½ä¼šå½±å“åˆ°è¿™ä¸ªç»„ä»¶çš„æ˜¾ç¤ºå½¢æ€.

 å½“æ•°æ®å˜åŒ–çš„æ—¶å€™, ç»„ä»¶çš„æ˜¾ç¤ºéœ€è¦æ›´æ–°. æ‰€ä»¥å¦‚æœç»„ä»¶åŒ–çš„æ¨¡å¼èƒ½æä¾›ä¸€ç§é«˜æ•ˆçš„æ–¹å¼è‡ªåŠ¨åŒ–åœ°å¸®åŠ©æˆ‘ä»¬æ›´æ–°é¡µé¢, é‚£ä¹Ÿå°±å¯ä»¥å¤§å¤§åœ°é™ä½æˆ‘ä»¬ä»£ç çš„å¤æ‚åº¦, å¸¦æ¥æ›´å¥½çš„å¯ç»´æŠ¤æ€§.

 å¥½äº†, è¯¾ç¨‹ç»“æŸäº†. ä½ å·²ç»å­¦ä¼šäº†æ€ä¹ˆä½¿ç”¨ React.js äº†, å› ä¸ºæˆ‘ä»¬å·²ç»å†™äº†ä¸€ä¸ªâ€”â€”å½“ç„¶æˆ‘æ˜¯åœ¨å¼€ç©ç¬‘, ä½†æ˜¯ä¸Šé¢è¿™ä¸ª Component ç±»å…¶å®å’Œ React çš„ Component ä½¿ç”¨æ–¹å¼å¾ˆç±»ä¼¼. æŒæ¡äº†è¿™å‡ èŠ‚çš„è¯¾ç¨‹, ä½ åŸºæœ¬å°±æŒæ¡äº†åŸºç¡€çš„ React.js çš„æ¦‚å¿µ.

 æ¥ä¸‹æ¥æˆ‘ä»¬å¼€å§‹æ­£å¼è¿›å…¥ä¸»é¢˜, å¼€å§‹æ­£å¼ä»‹ç» React.js. ä½ ä¼šå‘ç°, æœ‰äº†å‰é¢çš„é“ºå«, ä¸‹é¢è®²çš„å†…å®¹ç†è§£èµ·æ¥ä¼šç®€å•å¾ˆå¤šäº†.
